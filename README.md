<p align="center"><a href="https://cloudinary.com" target="_blank">			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 96.77" width="500" height="97" fill="blue">
				<path
					d="M160.53 30.41a17.14 17.14 0 0 1 13.56 6.7.69.69 0 0 0 1 .11l5.71-4.55a.71.71 0 0 0 .11-1 26 26 0 0 0-20.61-10.13c-14.91 0-27 12.85-27 28.65s12.13 28.65 27 28.65a25.85 25.85 0 0 0 20.6-10.12.69.69 0 0 0-.12-1l-5.7-4.5a.71.71 0 0 0-1 .11A17.26 17.26 0 0 1 160.53 70c-10.19 0-18.16-8.7-18.16-19.79s7.97-19.8 18.16-19.8ZM188.27 19.91h7.16a.71.71 0 0 1 .71.71V77.4a.7.7 0 0 1-.7.7h-7.16a.71.71 0 0 1-.71-.71V20.62a.7.7 0 0 1 .7-.71ZM220.54 39.55c-9.49 0-19.09 6.72-19.09 19.57 0 11.29 8.21 19.81 19.09 19.81s19.17-8.52 19.17-19.81-8.24-19.57-19.17-19.57Zm10.53 19.57c0 6.52-4.53 11.44-10.53 11.44s-10.44-4.92-10.44-11.44 4.49-11.2 10.44-11.2 10.53 4.81 10.53 11.2ZM278.3 40.37h-7.16a.7.7 0 0 0-.71.7v19c0 7.42-5.12 10.05-9.51 10.05-3.88 0-7.79-2.93-7.79-9.48V41.07a.7.7 0 0 0-.71-.7h-7.16a.7.7 0 0 0-.7.7v20.5c0 11.25 5.09 17.44 14.34 17.44 3.36 0 8.8-1.93 10.84-6.19l.69.14v4.44a.71.71 0 0 0 .71.71h7.16a.71.71 0 0 0 .71-.71V41.07a.7.7 0 0 0-.71-.7ZM322.27 19.91h-7.17a.7.7 0 0 0-.7.71V46l-.44-.7c-2.18-3.51-6.87-5.78-11.95-5.78-8.76 0-17.62 6.75-17.62 19.65 0 11.25 7.61 19.73 17.69 19.73 3.84 0 9.25-1.54 11.88-5.86l.44-.72v5.08a.7.7 0 0 0 .7.71h7.17a.7.7 0 0 0 .7-.71V20.62a.7.7 0 0 0-.7-.71Zm-8 39.21a11 11 0 0 1-10.75 11.36c-5.86 0-10.45-5-10.45-11.36s4.59-11.2 10.45-11.2a11 11 0 0 1 10.72 11.2ZM333 40.37h7.16a.7.7 0 0 1 .7.7V77.4a.7.7 0 0 1-.7.7H333a.71.71 0 0 1-.71-.71V41.07a.71.71 0 0 1 .71-.7ZM336.61 21.06a5.57 5.57 0 0 0-5.69 5.57 5.64 5.64 0 0 0 5.69 5.58 5.54 5.54 0 0 0 5.61-5.58 5.48 5.48 0 0 0-5.61-5.57ZM370.35 39.55c-3.14 0-8.72 1.69-10.85 6.19l-.69-.14v-4.53a.7.7 0 0 0-.71-.7h-7.16a.7.7 0 0 0-.7.7V77.4a.7.7 0 0 0 .7.71h7.16a.71.71 0 0 0 .71-.71v-19c0-7.36 5.12-10 9.51-10 3.88 0 7.79 2.91 7.79 9.4v19.6a.71.71 0 0 0 .71.71H384a.71.71 0 0 0 .71-.71V56.91c-.02-11.19-5.12-17.36-14.36-17.36ZM427.48 40.37h-7.16a.7.7 0 0 0-.71.7v5l-.43-.7c-2.19-3.51-6.88-5.78-12-5.78-8.75 0-17.62 6.75-17.62 19.65 0 11.25 7.61 19.73 17.7 19.73 3.83 0 9.24-1.54 11.88-5.86l.43-.72v5.01a.71.71 0 0 0 .71.71h7.16a.7.7 0 0 0 .7-.71V41.07a.7.7 0 0 0-.66-.7Zm-8 18.75a11 11 0 0 1-10.78 11.36c-5.86 0-10.44-5-10.44-11.36s4.58-11.2 10.44-11.2a11 11 0 0 1 10.76 11.2ZM460.15 40.5a13.66 13.66 0 0 0-5.14-1c-4.76 0-8.22 2.85-10 8.25l-.64-.09v-6.59a.7.7 0 0 0-.71-.7h-7.16a.7.7 0 0 0-.71.7V77.4a.71.71 0 0 0 .71.71h7.24a.7.7 0 0 0 .7-.71V65c0-14.8 5.91-17 9.44-17a11 11 0 0 1 4.33.9.72.72 0 0 0 .61 0 .7.7 0 0 0 .36-.48l1.42-7.11a.71.71 0 0 0-.45-.81ZM499.88 40.68a.69.69 0 0 0-.59-.31h-7.71a.72.72 0 0 0-.66.45L481.59 65l-9.42-24.18a.72.72 0 0 0-.66-.45h-7.86a.69.69 0 0 0-.58.31.7.7 0 0 0-.07.66l14 34.38-7.73 20.09a.71.71 0 0 0 .66 1h7.5a.69.69 0 0 0 .65-.45l21.86-55a.69.69 0 0 0-.06-.68ZM97.91 28.11A40.38 40.38 0 0 0 59.73 0 39.62 39.62 0 0 0 24.6 20.87a29.88 29.88 0 0 0-7.21 56.56l.75.34h.05v-8.5a22.29 22.29 0 0 1 9.29-41.16l2.1-.22.92-1.89A32.15 32.15 0 0 1 59.73 7.57a32.7 32.7 0 0 1 31.55 25l.72 2.86h3a18.53 18.53 0 0 1 18.15 18.46c0 7.05-4.07 12.82-11 15.74v8.06l.5-.16c11.14-3.65 18.06-12.71 18.06-23.64a26.19 26.19 0 0 0-22.8-25.78Z"></path>
				<path
					d="m45.07 76.79 1.66 1.66a.33.33 0 0 1-.23.56H33.4a6 6 0 0 1-6-6V47.57a.33.33 0 0 0-.33-.33h-2.8a.33.33 0 0 1-.24-.56l11.12-11.12a.33.33 0 0 1 .47 0l11.11 11.12a.33.33 0 0 1-.23.56h-2.84a.34.34 0 0 0-.34.33v25a6 6 0 0 0 1.75 4.22ZM69.64 76.79l1.67 1.66a.33.33 0 0 1-.24.56H58a6 6 0 0 1-6-6V54a.34.34 0 0 0-.33-.34h-2.83a.33.33 0 0 1-.23-.56L59.72 42a.33.33 0 0 1 .47 0l11.12 11.08a.33.33 0 0 1-.24.56h-2.84a.34.34 0 0 0-.33.34v18.59a6 6 0 0 0 1.74 4.22ZM94.22 76.79l1.66 1.66a.33.33 0 0 1-.23.56H82.54a6 6 0 0 1-6-6V60.38a.33.33 0 0 0-.33-.33h-2.8a.33.33 0 0 1-.23-.57L84.3 48.37a.32.32 0 0 1 .46 0l11.12 11.11a.33.33 0 0 1-.23.57H92.8a.33.33 0 0 0-.33.33v12.19a6 6 0 0 0 1.75 4.22Z"></path>
			</svg>
</a></p>

<h1 align="center">
 Cloudinary Watermark API with Laravel
</h1>

Cloudinary is a Software-as-a-Service (SaaS) solution for managing all your web or mobile application‚Äôs media assets in
the cloud. Cloudinary offers an end-to-end solution for all your image and video needs, including the upload, storage,
administration, transformation and optimized delivery.

Laravel is a PHP framework developed with developer productivity in mind. The framework also aims to evolve with the web and has already incorporated several new features and ideas in the web development world‚Äîsuch as job queues, **API authentication** out of the box, real-time communication, and much more.

## Introduction

In this article, we‚Äôll explore the ways you can build a simple Cloudinary Watermark API using Laravel. The API will allow you to add a watermark to an image using Cloudinary's powerful transformational API. We‚Äôll be using Laravel 8, and all of the code is available for reference on GitHub.

## Github

The entire source code is available on my [Github](https://github.com/victorokech/cloudinary-watermark-api) repository.

## Prerequisites

Using Cloudinary in your Laravel projects is pretty straightforward. However, for you to be able to easily follow along,
you need to have a good command of your terminal, Git and entry knowledge of PHP specifically with the Laravel
framework.

You also need to understand what a RESTful API is. REST stands for _REpresentational State Transfer_ and is an architectural style for network communication between applications, which relies on a stateless protocol (usually HTTP) for interaction.

Lastly, you will need an API Client/Platform such as [Postman](https://www.postman.com/) or [Insomnia](https://insomnia.rest/) installed on your system to test the API endpoints.

## Getting Started

Being that Laravel is a PHP Framework, we will need Composer. Like any modern PHP framework, Laravel uses Composer to manage its dependencies. So, before we can
start ensure you have Composer installed on your machine. Follow step 1 below to install Composer and PHP.

1. Install [Composer](https://getcomposer.org/) and [PHP](https://www.php.net/manual/en/install.windows.tools.php) on
   your development or production machine.
2. Install Laravel
   
   a) Via Composer:
   
   `composer create-project --prefer-dist laravel/laravel cloudinary-watermark-api`
   
   b) Via Laravel Installer
   
   `composer global require laravel/installer`
   
   `laravel new cloudinary-watermark-api`
3. In step 2b above we have installed the Laravel Installer and used it to scaffold a new application in the folder `cloudinary-watermark-api`. With Laravel installed, we should be able to start and test the server ensuring everything is okay. Change the directory to the project folder and run the local development server by typing the following commands:
   
   `cd cloudinary-watermark-api`
   
   `php artisan serve`

The Laravel Project is now up and running. When you open `http://localhost:8000` on your computer, you should see the image below:

![Laravel Server Running](https://res.cloudinary.com/dgrpkngjn/image/upload/v1655887283/watermark-api/assets/laravel-running_zqk8ol.png)

## Routes and Controllers

In the `routes/` folder you will notice that Laravel has a couple of files. We will work with the `routes/api.php` file to create the routes we need for our API.

For a start, we will need two endpoints, one to upload the watermark to Cloudinary and the other to create the watermark branded images, but you can add more routes you need as you continue exploring the Cloudinary APIs.

We have a route now we need to create a controller. Run the following commands to create one.

`php artisan make:controller WatermarkController`

This will create the controller `app/Http/Controllers/WatermarkController.php`

![WatermarkController](https://res.cloudinary.com/dgrpkngjn/image/upload/v1655887282/watermark-api/assets/watermark_controller_axuzlv.png)

At the moment it is empty, but we will populate it shortly. First things first, let us setup Cloudinary üôåüèæüòä.

## Setting up Cloudinary‚Äôs Laravel SDK

Cloudinary has a tonne of features from media upload, storage, administration, manipulation to optimization and delivery. In this case we will use Cloudinary's transformation features to create an API endpoint that will automatically overlay a brand/watermark image over our media.

That way our media content will be authentic and super professional which is a requirement for excellent brand management

To get started:

1. Sign up for a free Cloudinary account then navigate to the Console page and take note of your Cloud name, API Key and
   API Secret.
   
   ![Cloudinary Dashboard](https://res.cloudinary.com/dgrpkngjn/image/upload/v1655887283/watermark-api/assets/cloudinary_dashboard_m5d8ye.png)
2. Install [Cloudinary‚Äôs Laravel SDK](https://github.com/cloudinary-labs/cloudinary-laravel#installation):
   
   `composer require cloudinary-labs/cloudinary-laravel`

**Note**: Please ensure you follow all the steps in the #Installation section. Publish the configuration file and add
the Cloudinary credentials you noted in Step 1 to the `.env` file.

## Creating the Watermark Endpoint

We will make use of the `WatermarkController` we had created earlier. It will take two required inputs from the `POST` request:

1. `watermark` - This is a required image input of type PNG, since we need our watermark to be transparent in order to overlay it over other images.
2. `public_id` - We need to implicitly provide the public id for our watermark since we will need to specify this when performing the overlay transformation later on.

Open the file `app/Http/WatermarkController.php` and add the following code:

1. First we create the function upload which will correspond to our `watermark/upload` end point.

```php
public function upload(Request $request) {

}
```

2. Add the functionality to validate the required inputs, upload the watermark to Cloudinary and send a response to the user. Here is how it works:

```php
public function upload(Request $request): JsonResource {
    // Validates the request from the user
    // If the validation failed, throw a ValidationException and inform the user.
    $data = $this->validate($request, [
        'watermark' => [
            'required',
            'image',
            'mimes:png',
        ],
        'public_id' => [
            'required',
            'string'
        ]
    ]);

	// If there are no validation errors, proceed and upload the watermark to Cloudinary and return a JSON response to the user.
    $watermark = $data['watermark'];
    $public_id = $data['public_id'];
    cloudinary()->upload($watermark->getRealPath(), [
        'folder'    => 'watermark-api',
        'public_id' => $public_id
    ])->getSecurePath();
  
    return JsonResource::make([
        'message'   => "Watermark created successfully",
        'watermark' => ['public_id' => $public_id]
    ]);
}
```

3. Now we can link this in the routes file. Open your `routes/api.php` and add the following code:

`Route::post('watermark/upload', [WatermarkController::class, 'upload']);`

**Testing:** You can test the route using Postman or Insomnia. Below is an example of a successful and failed response:

| ![Successful API Response](https://res.cloudinary.com/dgrpkngjn/image/upload/v1655895878/watermark-api/assets/api_successful_response.png) |
| -------------------------------------------------------------------------------------------------------------------------------------------- |
| Successful API Response                                                                                                                    |

| ![Failed API Response](https://res.cloudinary.com/dgrpkngjn/image/upload/v1655895361/watermark-api/assets/api_failed_response.png) |
| ------------------------------------------------------------------------------------------------------------------------------------ |
| Failed API Response                                                                                                                |

Awesome, moving on nicely.

## Creating the Overlay or Branding Endpoint

By now you know how to create an endpoint, this should be a breeze. We will use the same `WatermarkController` but create a new method for this endpoint.

Similar to the previous endpoint this one will also take two inputs:

1. `media` - This is a required image/video input. It is the media file that we want branded with our cool watermark, we created earlier.
2. `public_id` - This is the public id of the watermark we passed to the previous endpoint. This needs to be exactly the same to the one we provided previously.

In our WatermarkController add the following method:

```php
public function create(Request $request): JsonResource {

}
```

We will populate the create method above with the following code:

```php
public function create(Request $request): JsonResource {
  // Validation
    $data = $this->validate($request, [
        'media'     => ['required', 'image', 'max:1024'],
        'public_id' => [
            'required',
            'string'
        ]
    ]);

    // Uploading image to Cloudinary with transformation parameters that will overlay our watermark on our image
    $media = $data['media'];
    $public_id = $data['public_id'];
    $branded = cloudinary()->upload($media->getRealPath(), [
        'folder'         => 'watermark-api',
        'transformation' => [
            'overlay' => $public_id,
            'gravity' => 'south_east', // watermark location bottom right
            'x'       => 0.02, // 2 percent offset horizontally
            'y'       => 0.02, // 2 percent offset vertically
            'crop'    => 'scale',
        ],
    ])->getSecurePath();

    // We return a response to the user with the URL of the branded or watermarked image
    return JsonResource::make([
        'message' => "Watermark created successfully",
        'url'     => $branded
    ]);
}
```

**Important:** Take note of the following transformation that makes the magic happen. Please refer to this [Cloudinary Layers documentation](https://cloudinary.com/documentation/layers) to learn more about these transformation options and experiment with several other awesome features:

1. `overlay` - This is the public id of the watermark we uploaded earlier. Please note that since we provided a `folder_name` when uploading the watermark. We will need to include the folder name in the `public_id` input we send to the server, otherwise, Cloudinary will look for the watermark in the root folder and not find it.
2. `gravity` - This is where the overlay will be placed. it can be center, north, south, east and so on and so forth.
3. `x` and `y` offsets - These parameters accept either integer values representing the number of pixels to adjust the overlay position in the horizontal or vertical direction, or decimal values representing a percentage-based offset relative to the containing image (e.g., 0.2 for an offset of 20%).
4. Install Livewire Package by running the following command in your Laravel project:
   `composer require livewire/livewire`

If you followed along this article keenly, you should be able to use an API client such as Postman or Insomnia to hit the endpoints to upload a watermark or create a watermarked/branded image similar to the one below:

| ![Cloudinary Watermarked Image](https://res.cloudinary.com/dgrpkngjn/image/upload/v1655904199/watermark-api/jnamglffdarl5pcyiujd.jpg) |
| --------------------------------------------------------------------------------------------------------------------------------------- |
| Photo by Justin  Brian: https://www.pexels.com/photo/city-landscape-beach-water-9833512/                                              |

**Note:** Cloudinary is super powerful for the management of your media assets in your project that will not only optimize your assets for visual quality but also cost savings in terms of performance, storage, AI-powered transformations as well.

## Integrating Swagger UI

Swagger is a powerful API documentation tool that simplifies API development for users, teams, and enterprises with the
Swagger open source and professional toolset. You can [find out](https://swagger.io) how Swagger can help you design and document your APIs at scale.

We will integrate Swagger to test the API we have just created. Let's start by installing the Swagger-UI library.

1. Using yarn

```
yarn add swagger-ui
```

2. Using npm

```
npm install swagger-ui
```

### The api.yaml file

Above we installed `swagger-ui` library which can render a YAML file as a Swagger interface. There are easier ways to do this using Laravel Swagger API dependencies but we will get our hands dirty by taking a more hands-on approach.

In our public folder we will create the `api.yaml` file.

Swagger API uses [OpenAPI](https://swagger.io/specification/) specifications, populate your api.yaml file with the following code:

```yaml
openapi: 3.0.0
info:
  title: Cloudinary Watermark API
  description: This API will allow you to add a watermark to an image using Cloudinary's powerful transformational API.
  version: 0.1.9

servers:
  - url: http://localhost:8000/api
    description: local server
  - url: http://production.app/api
    description: production server

paths:
  /watermark/upload:
    post:
      summary: Allows you to upload a watermark image to Cloudinary and set its public_id.
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                public_id:
                  required: true
                  type: string
                  default: 'cloudinary_blue_watermark'
                watermark:
                  required: true
                  type: string
                  format: binary
            encoding:
              watermark:
                # only accept png
                contentType: image/png
      responses:
        '200':
          description: A data object with a status message and a watermark object with the public_id and URL of the watermark uploaded if successful
          content:
            application/json:
              schema:
                type: object
                items:
                  type: string
              example:
                message: "Watermark uploaded successfully"
                watermark:
                  public_id: "cloudinary_blue_watermark"
        '422':
          description: Validation errors
          content:
            application/json:
              schema:
                type: object
              example:
                message: The given data was invalid
                errors:
                  watermark: The watermark field is required

  /watermark/create:
    post:
      summary: Allows you to upload the image file to be watermarked.
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                public_id:
                  required: true
                  type: string
                  default: 'watermark-api/cloudinary_blue_watermark'
                media:
                  required: true
                  type: string
                  format: binary
      responses:
        '200':
          description: A data object with a status message and the URL of the watermarked image
          content:
            application/json:
              schema:
                type: object
                items:
                  type: string
              example:
                message: "Watermark created successfully"
                url: https://res.cloudinary.com/dgrpkngjn/image/upload/v1663765850/watermark-api/php4C9E_jhbqjx.jpg
        '422':
          description: Validation errors
          content:
            application/json:
              schema:
                type: object
              example:
                message: The given data was invalid
                errors:
                  watermark: The media field is required
```

### Swagger.js file

Next, we will create a `swagger.js` in our `resources/js/` folder. This file will process the `api.yaml` file we created earlier and generate the Swagger interface:

```js
import SwaggerUI from 'swagger-ui'
import 'swagger-ui/dist/swagger-ui.css';

SwaggerUI({
    dom_id: '#swagger-ui',
    url: '/api.yaml',
});
```

This code snippet will generate the Swagger interface and mount it on the appropriate HTML tag with an ID ‚Äì **swagger-ui**.

In our `webpack.mix.js`, we instruct it to compile our `swagger.js` to the **public/js** directory for the browser to read it as a JavaScript file which we will then use in our `welcome.blade.php` file.

In the `resources/views/welcome.blade.php` file replace everything in between the **body** tags with the following code:

```html
<div id="swagger-ui"></div>
<script src="{{mix('js/swagger.js')}}"></script>
```

This code creates a mount point for Swagger using the id `swagger-ui` and imports the compiled **swagger.js**.

Please don't forget to run `npm run development` or `yarn development` to compile our JS files.

Awesome, we are done and when you run the Laravel server once more you should be able to see the following:

![Swagger UI Interface](https://res.cloudinary.com/dgrpkngjn/image/upload/v1663777220/watermark-api/assets/cloudinary-swagger-api_wsmm5n.png)



## PHPSandbox

You have been amazing üòä, following through the tutorial to the end excellently. The results can be viewed in the code embed below or directly on [PHPSandbox](https://phpsandbox.io/e/x/vvtv5?&layout=Preview&iframeId=11obz75t9b&theme=dark&defaultPath=/&showExplorer=no).

<figure style="height: 500px;"><iframe src="https://phpsandbox.io/e/x/vvtv5?&layout=Preview&iframeId=qfrxjf1uoh&theme=dark&defaultPath=/&showExplorer=no" style="display: block" loading="lazy" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" height="100%" width="100%"></iframe></figure>

# Excel with Cloudinary

Building an API is a whole technical process which requires you to think about the goals, architecture, testing, scaling, security and more, but in this implementation with Cloudinary we had fun building a very simple API.

Cloudinary is your A to Z media management solution - upload, storage, administration, manipulation, optimization and delivery.

[Get started](https://cloudinary.com/signup) with Cloudinary in your Laravel projects for FREE!

